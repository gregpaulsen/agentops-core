#!/usr/bin/env bash
set -euo pipefail
branch="$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "")"
if [ "$branch" = "main" ] && [ "${ALLOW_MAIN:-0}" != "1" ]; then
  echo "❌ Direct push to main blocked. Open a PR or set ALLOW_MAIN=1 to override." >&2
  exit 1
fi
# Fail if any tracked file > 100MB not handled by LFS (prevents GitHub rejection)
limit=$((100*1024*1024)); bad=0
while IFS= read -r -d '' f; do
  [ -f "$f" ] || continue
  size=$(wc -c <"$f")
  if [ "$size" -gt "$limit" ] && ! git check-attr -a -- "$f" | grep -q 'filter: lfs'; then
    echo "❌ >100MB tracked file: $f ($((size/1024/1024))MB). Use Git LFS or move to storage/." >&2
    bad=1
  fi
done < <(git ls-files -z)
exit $bad
